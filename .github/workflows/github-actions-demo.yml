name: Tracking backend preparation

on:
        push:
                branches:
                        - main

jobs:
        integration-tests:
                name: Integration tests
                runs-on: ubuntu-latest
                strategy:
                        matrix:
                                python: [3.9]
                                poetry: [1.1.4]
                services:
                        postgres:
                                image: postgres:latest
                                env:
                                        POSTGRES_DB: trackme
                                        POSTGRES_PASSWORD: postgres
                                        POSTGRES_USER: postgres
                                ports:
                                        - 5432:5432
                steps:
                        - name: Git checkout 
                          uses: actions/checkout@v2
                        - name: Provide dotenv file
                          run: |
                                  touch .env
                                  echo "DB_URI=postgresql+asyncpg://postgres:postgres@localhost:5432/trackme" > .env
                        - name: Build container
                          run: make build 
                        # - name: Setting up environment
                        #   uses: actions/setup-python@v2
                        #   with:
                        #           python-version: ${{ matrix.python }}
                        # - name: Prepare poetry
                        #   uses: abatilo/actions-poetry@v2.0.0
                        #   with:
                        #         poetry-version: ${{ matrix.poetry }}
                        # - name: Install dependencies
                        #   run: make local-setup
                        - name: Run alembic migration
                          run: make docker-migrate
